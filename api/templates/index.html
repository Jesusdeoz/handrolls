{% extends "base.html" %}
{% block title %}Nuevo pedido{% endblock %}
{% block content %}

<h2>Crear pedido</h2>
<form method="post" action="/orders" class="card">
  <label>Nombre cliente<br><input name="cliente_nombre" required></label><br><br>

  <label>Tel√©fono<br>
    <input name="telefono" type="tel" inputmode="numeric" autocomplete="tel" placeholder="+56912345678" pattern="[0-9+ ]*">
  </label><br><br>

  <!-- Selector de PROMO arriba de Detalle -->
  <label>Promoci√≥n (opcional)<br>
    <input id="promoSearch" list="promos_datalist" placeholder="Escribe o elige N¬∞ de promo" autocomplete="off" style="width:240px">
    <datalist id="promos_datalist"></datalist>
    <button type="button" class="btn btn-sm" id="clearPromo">Limpiar</button>
  </label>
  <div class="sub">Al elegir una promo, se rellenan autom√°ticamente Detalle y Monto. Luego puedes ajustar si quieres.</div>
  <br>

  <label>Detalle (ej: 2 salm√≥n, 1 pollo)<br>
    <textarea name="detalle" id="detalleField" class="textarea-lg" rows="5" required style="width:100%"></textarea>
  </label><br><br>

  <fieldset>
    <legend>Soya</legend>
    <label>
      <input type="number" name="soya_normal_qty" min="0" placeholder="0" style="width:70px">
      Soya normal
    </label>
    <label style="margin-left:16px">
      <input type="number" name="soya_dulce_qty" min="0" placeholder="0" style="width:70px">
      Soya dulce
    </label>
    <div class="sub">Deja en blanco o 0 si no corresponde.</div>
  </fieldset><br>

  <fieldset>
    <legend>Modalidad</legend>
    <label><input type="radio" name="modalidad" value="retiro" checked> Retiro</label>
    <label><input type="radio" name="modalidad" value="despacho"> Despacho</label>
  </fieldset><br>

  <div id="direccionBox" style="display:none">
    <label>Direcci√≥n<br><input name="direccion"></label><br><br>
    <label>Comuna<br><input name="comuna" placeholder="ej: Maip√∫"></label><br><br>
  </div>

  <label>M√©todo de pago<br>
    <select name="medio_pago" required>
      <option value="debito_credito">D√©bito/Cr√©dito</option>
      <option value="transferencia">Transferencia</option>
      <option value="efectivo">Efectivo</option>
    </select>
  </label><br><br>

  <label>Monto total (CLP)<br>
    <input name="monto_total_clp" id="montoField" type="number" min="0">
  </label><br><br>

  <label>Observaciones<br>
    <textarea name="observaciones" class="textarea-lg" rows="3" style="width:100%" placeholder="sin ceboll√≠n, al√©rgenos, timbre, etc."></textarea>
  </label><br><br>

  <button class="btn" type="submit">Crear pedido</button>
</form>

<hr>

<h2>Gesti√≥n y edici√≥n de pedidos (solo mostrador)</h2>
<p>La cocina solo visualiza.</p>

<style>
  .table { width:100%; border-collapse:collapse; }
  .table thead th { text-align:left; font-weight:600; padding:12px; border-bottom:1px solid #e5e7eb; color:#374151; }
  .table tbody td { padding:12px; border-bottom:1px solid #f1f5f9; vertical-align:top; }
  .right { text-align:right; }
  .sub { color:#6b7280; font-size:12px; }
  .wrap { white-space: pre-wrap; word-break: break-word; }

  .badge { display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:600; }
  .badge-green { background:#dcfce7; color:#166534; }  /* Pendiente */
  .badge-red   { background:#fee2e2; color:#991b1b; }  /* Entregado */

  .row-green { border-left:4px solid #22c55e; }
  .row-red   { border-left:4px solid #ef4444; }

  .btn-sm { padding:6px 8px; font-size:12px; }
  .actions .btn-sm{ margin-right:6px; margin-bottom:6px; display:inline-block; }

  .toolbar { display:flex; align-items:center; gap:8px; margin: 8px 0 12px; }
  .toolbar select { padding:6px 8px; }

  .textarea-lg { width:100%; min-height:90px; }
</style>

<div class="card">
  <div class="toolbar">
    <label>Mostrar:
      <select id="stateFilter">
        <option value="all">Todos</option>
        <option value="pending" selected>Pendientes</option>
        <option value="delivered">Entregados</option>
      </select>
    </label>
  </div>

  <table class="table">
    <thead>
      <tr>
        <th>Pedido</th>
        <th>Hora</th>
        <th>Cliente</th>
        <th>Estado</th>
        <th>Pago</th>
        <th class="right">Total</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="orders_tbody"></tbody>
  </table>
</div>

<hr>

<h2>Promos</h2>
<p class="sub">Crea o actualiza tus promociones. El <strong>n¬∫ de promo</strong> debe ser √∫nico.</p>
<form method="post" action="/promos" class="card">
  <label>N¬∫ Promo<br>
    <input name="promo_nro" required placeholder="ej: 101">
  </label><br><br>
  <label>Detalle promo<br>
    <textarea name="promo_detalle" class="textarea-lg" rows="3" style="width:100%" required></textarea>
  </label><br><br>
  <label>Monto promo (CLP)<br>
    <input name="promo_monto" type="number" min="0" required>
  </label><br><br>
  <button class="btn" type="submit">Guardar promoci√≥n</button>
</form>

<script>
  // Mostrar/ocultar direcci√≥n seg√∫n modalidad en el formulario de "Crear pedido"
  const radios = document.querySelectorAll('input[name="modalidad"]');
  const box = document.getElementById('direccionBox');
  function toggleDir() {
    const v = [...radios].find(r=>r.checked)?.value;
    box.style.display = (v === 'despacho') ? '' : 'none';
  }
  radios.forEach(r=>r.addEventListener('change', toggleDir));
  toggleDir();

  // --------- PROMOS: cargar y autocompletar -----------
  let PROMOS = [];
  const promoInput   = document.getElementById('promoSearch');
  const promoList    = document.getElementById('promos_datalist');
  const detalleField = document.getElementById('detalleField');
  const montoField   = document.getElementById('montoField');
  const clearBtn     = document.getElementById('clearPromo');

  async function loadPromos() {
    try {
      const r = await fetch('/api/promos', { cache: 'no-store' });
      PROMOS = await r.json();
      promoList.innerHTML = PROMOS.map(p => {
        const label = `${p.promo_nro} ‚Äî ${p.detalle} (${Number(p.monto || 0).toLocaleString('es-CL', { style:'currency', currency:'CLP' })})`;
        return `<option value="${p.promo_nro}" label="${label}"></option>`;
      }).join('');
    } catch (e) {
      console.error('Error cargando promos', e);
    }
  }

  // (1) ‚õîÔ∏è Sin confirmaciones. Al elegir una promo, rellenamos sin preguntar.
  function tryApplyPromo() {
    const val = (promoInput.value || '').trim();
    if (!val) return;
    const p = PROMOS.find(x => String(x.promo_nro) === val);
    if (!p) return;

    // ‚úÖ Sobrescribe directamente
    detalleField.value = p.detalle || '';
    montoField.value   = (p.monto != null) ? (parseInt(p.monto, 10) || 0) : '';
  }

  // (2) ‚úÖ Usa SOLO 'change' para evitar dobles disparos (quitamos 'blur')
  promoInput.addEventListener('change', tryApplyPromo);

  // (3) Bot√≥n "Limpiar" solo borra la selecci√≥n de promo
  clearBtn.addEventListener('click', () => {
    promoInput.value = '';
  });

  loadPromos();

  // --------- Listado + filtro por estado ----------
  const filterSelect = document.getElementById('stateFilter');
  let FILTER = filterSelect ? filterSelect.value : 'pending';

  filterSelect.addEventListener('change', () => {
    FILTER = filterSelect.value;
    render();
  });

  async function fetchAll() {
    const r = await fetch(`/api/orders`, { cache: 'no-store' });
    return await r.json();
  }

  function hhmm(ts) {
    const d = new Date(ts);
    const hh = String(d.getHours()).padStart(2, '0');
    const mm = String(d.getMinutes()).padStart(2, '0');
    return `${hh}:${mm}`;
  }

  function esc(s) {
    return (s ?? '').toString().replace(/[&<>"']/g, m =>
      ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])
    );
  }

  function pagoLabel(v) {
    switch ((v || '').toLowerCase()) {
      case 'efectivo': return 'Efectivo';
      case 'debito_credito': return 'D√©bito/Cr√©dito';
      case 'transferencia': return 'Transferencia';
      default: return v || '-';
    }
  }

  function isDelivered(p) {
    const st = (p.estado || '').toLowerCase();
    return ['despachado','entregado','retirado'].includes(st);
  }

  async function act(id, action) {
    await fetch(`/api/orders/${id}`, {
      method: 'PATCH',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({action})
    });
    await render();
  }

  // Formatea "normal:2;dulce:1" a una cadena legible
  function formatSoya(s) {
    if (!s) return "";
    const map = {};
    s.split(";").forEach(pair => {
      const [k, v] = pair.split(":");
      if (k && v) map[k.trim()] = parseInt(v, 10) || 0;
    });
    const parts = [];
    if (map.normal) parts.push(`Soya normal x${map.normal}`);
    if (map.dulce)  parts.push(`Soya dulce x${map.dulce}`);
    return parts.join(", ");
  }

  function row(p) {
    const delivered = isDelivered(p);
    const estadoLabel = delivered ? 'Entregado' : 'Pendiente';
    const badge = delivered ? 'badge-red' : 'badge-green';
    const rowCls = delivered ? 'row-red' : 'row-green';

    const total = Number(p.monto_total_clp || 0).toLocaleString('es-CL', { style:'currency', currency:'CLP' });
    const hora = hhmm(p.hora_creacion);

    const tel = p.telefono ? `<div class="sub">${esc(p.telefono)}</div>` : '';
    const soyaTxt = formatSoya(p.salsas);
    const det = (p.detalle || soyaTxt || p.observaciones)
      ? `<div class="sub">üìù ${p.detalle ? esc(p.detalle) : ''}${soyaTxt ? (p.detalle ? ' ‚Äî ' : '') + esc(soyaTxt) : ''}${p.observaciones ? (p.detalle || soyaTxt ? ' ‚Äî ' : '') + 'Obs: ' + esc(p.observaciones) : ''}</div>`
      : '';

    // Acciones: solo "Marcar Entregado" (si a√∫n no lo est√°) y "Editar"
    const actions = `
      ${delivered ? '' : `<button class="btn btn-sm" onclick="act(${p.id}, 'entregado')">Marcar Entregado</button>`}
      <a class="btn btn-sm" href="/orders/${p.id}/edit">Editar</a>
    `;

    return `
      <tr class="${rowCls}">
        <td>#${p.id}</td>
        <td>${hora}</td>
        <td>${esc(p.cliente_nombre)} ${tel} ${det}</td>
        <td><span class="badge ${badge}">${estadoLabel}</span></td>
        <td>${esc(pagoLabel(p.medio_pago))}</td>
        <td class="right">${total}</td>
        <td class="actions">${actions}</td>
      </tr>
    `;
  }

  async function render() {
    const all = await fetchAll();

    let rows = all;
    if (FILTER === 'pending') {
      rows = all.filter(p => !isDelivered(p));
    } else if (FILTER === 'delivered') {
      rows = all.filter(p => isDelivered(p));
    }

    document.getElementById('orders_tbody').innerHTML = rows.map(row).join('');
  }

  render();
  setInterval(render, 4000);
</script>

{% endblock %}


